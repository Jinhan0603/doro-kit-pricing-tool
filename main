import React, { useState, useMemo } from 'react';
import { 
  Calculator, 
  TrendingDown, 
  TrendingUp, 
  Layout, 
  DollarSign, 
  Info, 
  AlertCircle,
  BarChart3
} from 'lucide-react';

const App = () => {
  // --- 상태 관리 ---
  const [exchangeRate, setExchangeRate] = useState(1453.75);
  const [targetMargin, setTargetMargin] = useState(35); // 목표 공헌이익률 (%)
  const [paymentFee, setPaymentFee] = useState(3); // 결제 수수료 (%)
  const [expectedSales, setExpectedSales] = useState(1000); // 예상 판매량 (콘텐츠 원가 계산용)

  // 변동비 항목
  const [costs, setCosts] = useState({
    bom: 15000,
    packaging: 2000,
    labor: 3000,
    shipping: 2500,
    replacementRate: 5, // %
    replacementUnitCost: 10000,
    csMinutes: 10,
    csCostPerMin: 200,
    contentTotalCost: 5000000,
  });

  // 판매가 시뮬레이션
  const [testPrice, setTestPrice] = useState(49000);

  // --- 계산 로직 ---
  const calculatedData = useMemo(() => {
    const { 
      bom, packaging, labor, shipping, 
      replacementRate, replacementUnitCost, 
      csMinutes, csCostPerMin, contentTotalCost 
    } = costs;

    // 1. 기대 A/S 비용
    const asExpectation = (replacementRate / 100) * replacementUnitCost;
    // 2. CS 기대비용
    const csExpectation = csMinutes * csCostPerMin;
    // 3. 콘텐츠 원가/키트
    const contentPerKit = contentTotalCost / expectedSales;
    
    // 순수 변동비 합계 (수수료 제외)
    const pureVariableCost = bom + packaging + labor + shipping + asExpectation + csExpectation + contentPerKit;
    
    // 바닥 가격 (목표 공헌이익과 수수료를 고려한 마지노선)
    // 가격 = 변동비 / (1 - 수수료율 - 목표이익률)
    const floorPrice = pureVariableCost / (1 - (paymentFee / 100) - (targetMargin / 100));

    // 현재 테스트 가격에서의 지표
    const feeAmount = testPrice * (paymentFee / 100);
    const contributionMargin = testPrice - pureVariableCost - feeAmount;
    const marginRate = (contributionMargin / testPrice) * 100;

    return {
      pureVariableCost,
      asExpectation,
      csExpectation,
      contentPerKit,
      floorPrice,
      feeAmount,
      contributionMargin,
      marginRate
    };
  }, [costs, expectedSales, targetMargin, paymentFee, testPrice]);

  // 시장 데이터 (환율 반영)
  const marketBenchmarks = [
    { name: 'KiwiCo (Entry)', usd: 24, type: 'Entry' },
    { name: 'CrunchLabs (Build Box)', usd: 29.95, type: 'Core' },
    { name: 'MEL Science (Avg)', usd: 34.90, type: 'Core' },
    { name: 'CrunchLabs (Hack Pack)', usd: 33.33, type: 'Premium' },
  ];

  const formatKRW = (val) => Math.round(val).toLocaleString() + '원';

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900">
      <div className="max-w-6xl mx-auto">
        {/* 헤더 */}
        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <Calculator className="text-blue-600" />
              DORO 교보재 가격 측정 시뮬레이터
            </h1>
            <p className="text-slate-500 text-sm mt-1">변동비 기반 바닥가 및 시장 복도 데이터 분석</p>
          </div>
          <div className="flex items-center gap-4 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
            <div className="text-xs font-semibold text-slate-400 uppercase tracking-wider">적용 환율 (1$)</div>
            <input 
              type="number" 
              value={exchangeRate}
              onChange={(e) => setExchangeRate(Number(e.target.value))}
              className="w-24 text-right font-bold text-blue-600 focus:outline-none"
            />
            <span className="text-slate-400">KRW</span>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* 왼쪽: 입력 섹션 */}
          <div className="lg:col-span-2 space-y-6">
            
            {/* 1. 변동비 입력 */}
            <section className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                <TrendingDown className="text-red-500" size={20} />
                1. 우리의 바닥 (변동비 상세)
              </h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <label className="block">
                    <span className="text-sm font-medium text-slate-600">BOM/재료비 (부품, 소재 등)</span>
                    <input type="number" value={costs.bom} onChange={e => setCosts({...costs, bom: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                  </label>
                  <label className="block">
                    <span className="text-sm font-medium text-slate-600">포장 및 인쇄물</span>
                    <input type="number" value={costs.packaging} onChange={e => setCosts({...costs, packaging: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                  </label>
                  <label className="block">
                    <span className="text-sm font-medium text-slate-600">인건비 (조립, 검수, 패킹)</span>
                    <input type="number" value={costs.labor} onChange={e => setCosts({...costs, labor: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                  </label>
                  <label className="block">
                    <span className="text-sm font-medium text-slate-600">배송비 (회사 부담분)</span>
                    <input type="number" value={costs.shipping} onChange={e => setCosts({...costs, shipping: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                  </label>
                </div>
                
                <div className="space-y-4">
                  <div className="p-4 bg-slate-50 rounded-xl border border-slate-100 space-y-4">
                    <h3 className="text-xs font-bold text-slate-400 uppercase">기대 비용 및 콘텐츠 원가</h3>
                    <label className="block">
                      <span className="text-sm font-medium text-slate-600">교체/파손 기대율 (%)</span>
                      <input type="number" value={costs.replacementRate} onChange={e => setCosts({...costs, replacementRate: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                    </label>
                    <label className="block">
                      <span className="text-sm font-medium text-slate-600">평균 CS 상담 시간 (분/키트)</span>
                      <input type="number" value={costs.csMinutes} onChange={e => setCosts({...costs, csMinutes: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                    </label>
                    <label className="block">
                      <span className="text-sm font-medium text-slate-600">콘텐츠 총 제작비 (예상)</span>
                      <input type="number" value={costs.contentTotalCost} onChange={e => setCosts({...costs, contentTotalCost: Number(e.target.value)})} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                    </label>
                    <label className="block">
                      <span className="text-sm font-medium text-slate-600">목표 판매량 (n개)</span>
                      <input type="number" value={expectedSales} onChange={e => setExpectedSales(Number(e.target.value))} className="mt-1 block w-full border-slate-200 rounded-lg shadow-sm" />
                    </label>
                  </div>
                </div>
              </div>
            </section>

            {/* 2. 시장 복도 비교 */}
            <section className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
              <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
                <Layout className="text-emerald-500" size={20} />
                2. 시장 복도 (글로벌 벤치마크)
              </h2>
              <div className="overflow-hidden border border-slate-100 rounded-xl">
                <table className="w-full text-left text-sm">
                  <thead className="bg-slate-50 text-slate-500">
                    <tr>
                      <th className="px-4 py-3 font-semibold">브랜드 / 서비스</th>
                      <th className="px-4 py-3 font-semibold text-right">USD</th>
                      <th className="px-4 py-3 font-semibold text-right">KRW 환산</th>
                      <th className="px-4 py-3 font-semibold">구분</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-50">
                    {marketBenchmarks.map((m, i) => (
                      <tr key={i} className="hover:bg-slate-50 transition-colors">
                        <td className="px-4 py-3 font-medium">{m.name}</td>
                        <td className="px-4 py-3 text-right text-slate-500">${m.usd.toFixed(2)}</td>
                        <td className="px-4 py-3 text-right font-bold text-slate-700">{formatKRW(m.usd * exchangeRate)}</td>
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded-full text-[10px] font-bold uppercase ${
                            m.type === 'Entry' ? 'bg-blue-50 text-blue-600' : 
                            m.type === 'Core' ? 'bg-emerald-50 text-emerald-600' : 'bg-purple-50 text-purple-600'
                          }`}>
                            {m.type}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>
          </div>

          {/* 오른쪽: 결과 리포트 섹션 */}
          <div className="space-y-6">
            
            {/* 핵심 지표 */}
            <div className="bg-slate-900 text-white rounded-2xl p-6 shadow-xl">
              <h3 className="text-slate-400 text-xs font-bold uppercase mb-4 tracking-widest">Pricing Analysis</h3>
              
              <div className="space-y-6">
                <div>
                  <p className="text-sm text-slate-400">계산된 키트당 총 변동비</p>
                  <p className="text-3xl font-bold">{formatKRW(calculatedData.pureVariableCost)}</p>
                </div>

                <div className="pt-6 border-t border-slate-800">
                  <p className="text-sm text-slate-400 mb-1">마지노선 판매가 (바닥)</p>
                  <div className="flex items-end gap-2">
                    <p className="text-2xl font-bold text-red-400">{formatKRW(calculatedData.floorPrice)}</p>
                    <span className="text-xs text-slate-500 mb-1">({targetMargin}% 마진 기준)</span>
                  </div>
                </div>

                <div className="space-y-3">
                  <div className="flex justify-between text-xs">
                    <span className="text-slate-400">목표 공헌이익률 설정</span>
                    <span className="font-bold text-blue-400">{targetMargin}%</span>
                  </div>
                  <input 
                    type="range" min="10" max="70" value={targetMargin} 
                    onChange={e => setTargetMargin(Number(e.target.value))}
                    className="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-500"
                  />
                </div>
              </div>
            </div>

            {/* 가격 시뮬레이터 */}
            <div className="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
              <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                <BarChart3 size={18} className="text-blue-500" />
                판매가 시뮬레이션
              </h3>
              
              <div className="space-y-4">
                <label className="block">
                  <span className="text-sm font-medium text-slate-500">테스트 판매가 설정</span>
                  <div className="mt-1 flex items-center gap-2">
                    <input 
                      type="number" 
                      step="1000"
                      value={testPrice} 
                      onChange={e => setTestPrice(Number(e.target.value))} 
                      className="block w-full text-lg font-bold border-slate-200 rounded-lg shadow-sm text-blue-600 focus:ring-blue-500"
                    />
                    <span className="font-bold text-slate-400">원</span>
                  </div>
                </label>

                <div className="p-4 rounded-xl bg-slate-50 space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-sm text-slate-500">결제 수수료 ({paymentFee}%)</span>
                    <span className="text-sm font-medium">-{formatKRW(calculatedData.feeAmount)}</span>
                  </div>
                  <div className="flex justify-between items-center pt-2 border-t border-slate-200">
                    <span className="text-sm font-bold text-slate-700">최종 공헌이익</span>
                    <span className={`font-bold ${calculatedData.contributionMargin > 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                      {formatKRW(calculatedData.contributionMargin)}
                    </span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-sm font-bold text-slate-700">이익률</span>
                    <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                      calculatedData.marginRate >= targetMargin ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                    }`}>
                      {calculatedData.marginRate.toFixed(1)}%
                    </span>
                  </div>
                </div>

                {/* 가격대 피드백 */}
                <div className={`p-4 rounded-xl text-sm flex gap-3 ${
                  testPrice >= 60000 ? 'bg-orange-50 text-orange-800 border border-orange-100' :
                  testPrice >= 49000 ? 'bg-blue-50 text-blue-800 border border-blue-100' :
                  'bg-emerald-50 text-emerald-800 border border-emerald-100'
                }`}>
                  <AlertCircle size={20} className="shrink-0" />
                  <div>
                    <p className="font-bold">
                      {testPrice >= 60000 ? '프리미엄/이탈 주의 구간' : 
                       testPrice >= 49000 ? '프리미엄 복도 (설득 필요)' : '대중적 복도 (메인 전장)'}
                    </p>
                    <p className="text-xs mt-1 opacity-80">
                      {testPrice >= 60000 ? '상당한 브랜드 가치와 품질 설득이 없으면 구매 저항이 매우 강한 구간입니다.' :
                       testPrice >= 49000 ? 'CrunchLabs Hack Pack 등 프리미엄 라인과 경쟁하는 가격대입니다.' :
                       '글로벌 주요 STEM 구독 박스가 가장 많이 포진된 합리적 구간입니다.'}
                    </p>
                  </div>
                </div>
              </div>
            </div>

            {/* 천장 안내 */}
            <div className="bg-amber-50 rounded-2xl p-6 border border-amber-100">
              <h3 className="font-bold text-amber-800 mb-2 flex items-center gap-2">
                <TrendingUp size={18} />
                고객의 천장 (심리적 저항선)
              </h3>
              <ul className="text-xs space-y-2 text-amber-900 opacity-90">
                <li className="flex justify-between"><span>너무 비싸서 안 사는 가격:</span> <b>40만원+</b></li>
                <li className="flex justify-between"><span>비싸다고 느끼는 가격:</span> <b>20만원</b></li>
                <li className="flex justify-between"><span>싸다고 느끼는 가격:</span> <b>5만원</b></li>
                <li className="flex justify-between"><span>품질 의심 가격:</span> <b>1~2만원</b></li>
              </ul>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
